<!DOCTYPE html>
<html>
<head>
  <title>Video Analytics Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial; background:#f4f6f8; margin:0; padding:20px }
    h2 { margin-top:0 }
    .box {
      background:#fff; padding:15px; margin-bottom:20px;
      box-shadow:0 0 8px #ccc; border-radius:5px;
    }
    input, select, button {
      padding:8px; margin:5px;
    }
    table {
      width:100%; border-collapse:collapse;
    }
    th, td {
      border:1px solid #ddd; padding:8px; font-size:14px;
    }
    th { background:#eee }
  </style>
</head>
<body>

<h2>ðŸ“Š Video Analytics Dashboard</h2>

<div class="box">
  <b>Upload Meta / Manual Excel</b><br>
  <input type="file" id="excel">
  <button onclick="uploadExcel()">Upload</button>
  <span id="uploadMsg"></span>
</div>

<div class="box">
  <input id="query" placeholder="Keyword or #hashtag">
  <input type="date" id="start">
  <input type="date" id="end">

  <select id="source">
    <option value="all">All</option>
    <option value="youtube">YouTube</option>
    <option value="manual">Manual (Excel)</option>
  </select>

  <button onclick="loadData()">Load Data</button>
</div>

<div class="box">
  <canvas id="viewsChart"></canvas>
</div>

<div class="box">
  <b>Results</b>
  <table id="tbl">
    <thead>
      <tr>
        <th>Platform</th>
        <th>Title</th>
        <th>Channel</th>
        <th>Date</th>
        <th>Views</th>
        <th>Likes</th>
        <th>Comments</th>
        <th>Link</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
let chart;

async function uploadExcel(){
  const f = excel.files[0];
  if(!f) return alert("Select Excel file");
  const fd = new FormData();
  fd.append("file", f);

  const r = await fetch("/upload-excel", { method:"POST", body:fd });
  const d = await r.json();
  uploadMsg.innerText = "Uploaded " + d.rows + " rows";
}

async function loadData(){
  const q = query.value || "";
  const s = start.value;
  const e = end.value;
  const src = source.value;

  if(!s || !e) return alert("Select date range");

  const r = await fetch(
    `/combined-videos?query=${q}&start=${s}&end=${e}&source=${src}`
  );
  const d = await r.json();

  renderTable(d.videos);
  renderChart(d.videos);
}

function renderTable(rows){
  const tb = document.querySelector("#tbl tbody");
  tb.innerHTML = "";
  rows.forEach(r=>{
    tb.innerHTML += `
      <tr>
        <td>${r.platform}</td>
        <td>${r.title}</td>
        <td>${r.channel}</td>
        <td>${r.published}</td>
        <td>${r.views}</td>
        <td>${r.likes}</td>
        <td>${r.comments}</td>
        <td><a href="${r.url}" target="_blank">Open</a></td>
      </tr>`;
  });
}

function renderChart(rows){
  const labels = rows.map(r=>r.published);
  const views = rows.map(r=>r.views);

  if(chart) chart.destroy();

  chart = new Chart(
    document.getElementById("viewsChart"), {
      type:"line",
      data:{
        labels:labels,
        datasets:[{
          label:"Views",
          data:views,
          borderWidth:2
        }]
      }
    }
  );
}
</script>

</body>
</html>
