<!DOCTYPE html>
<html>
<head>
  <title>TN Politics YouTube Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 p-6">

<h1 class="text-3xl font-bold mb-6">
  Tamil Nadu Politics â€“ YouTube Dashboard
</h1>

<!-- Controls -->
<div class="bg-white p-4 rounded shadow flex flex-wrap gap-3 items-end">

  <input id="query" class="border p-2 rounded w-64"
         value="Tamil Nadu politics"
         placeholder="Search keyword">

  <input id="start" type="date" class="border p-2 rounded">
  <input id="end" type="date" class="border p-2 rounded">

  <button onclick="preset(7)" class="px-3 py-2 bg-gray-200 rounded">7 Days</button>
  <button onclick="preset(30)" class="px-3 py-2 bg-gray-200 rounded">30 Days</button>

  <button id="loadBtn" class="bg-blue-600 text-white px-6 py-2 rounded">
    Load Data
  </button>

  <button id="exportBtn" class="bg-green-600 text-white px-6 py-2 rounded">
    Export Excel
  </button>
</div>

<div id="loading" class="hidden mt-4 text-blue-600 font-semibold">
  Loading videos...
</div>

<p class="mt-4 text-lg">
  Total Videos: <span id="count" class="font-bold">0</span>
</p>

<!-- Table -->
<div class="overflow-x-auto bg-white mt-4 rounded shadow">
<table class="w-full text-sm">
<thead class="bg-gray-200">
<tr>
  <th class="p-2">Title</th>
  <th class="p-2">Channel</th>
  <th class="p-2">Date</th>
  <th class="p-2">Views</th>
  <th class="p-2">Likes</th>
  <th class="p-2">Comments</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<!-- Chart Selector -->
<div class="mt-6 bg-white p-4 rounded shadow flex gap-4">
  <button onclick="showChart('views')" class="bg-blue-600 text-white px-4 py-2 rounded">Views</button>
  <button onclick="showChart('likes')" class="bg-green-600 text-white px-4 py-2 rounded">Likes</button>
  <button onclick="showChart('comments')" class="bg-purple-600 text-white px-4 py-2 rounded">Comments</button>
  <button onclick="showChart('channel')" class="bg-gray-800 text-white px-4 py-2 rounded">Channel</button>
</div>

<!-- Single Chart -->
<div class="bg-white mt-4 p-4 rounded shadow">
  <canvas id="chart" height="120"></canvas>
</div>

<script>
const today = new Date().toISOString().split("T")[0];
let videos = [];
let chart;

preset(7);

function preset(days){
  end.value = today;
  start.value = new Date(Date.now() - days*86400000)
    .toISOString().split("T")[0];
}

loadBtn.onclick = async () => {
  loading.classList.remove("hidden");
  tbody.innerHTML = "";

  const res = await fetch(
    `/search?query=${encodeURIComponent(query.value)}&start=${start.value}&end=${end.value}`
  );
  const data = await res.json();

  loading.classList.add("hidden");
  videos = data.videos;
  count.textContent = data.total;

  tbody.innerHTML = videos.map(v => `
    <tr class="border-t">
      <td class="p-2">${v.title}</td>
      <td class="p-2">${v.channel}</td>
      <td class="p-2">${v.published}</td>
      <td class="p-2 text-right">${v.views}</td>
      <td class="p-2 text-right">${v.likes}</td>
      <td class="p-2 text-right">${v.comments}</td>
    </tr>
  `).join("");

  showChart("views");
};

function showChart(type){
  chart?.destroy();

  let labels, data, label, chartType="line";

  if(type === "channel"){
    const m = {};
    videos.forEach(v => m[v.channel] = (m[v.channel] || 0) + v.views);
    labels = Object.keys(m);
    data = Object.values(m);
    label = "Views by Channel";
    chartType = "bar";
  } else {
    labels = videos.map(v => v.published);
    data = videos.map(v => v[type]);
    label = type.charAt(0).toUpperCase()+type.slice(1);
    chartType = type === "comments" ? "bar" : "line";
  }

  chart = new Chart(document.getElementById("chart"), {
    type: chartType,
    data: {
      labels,
      datasets: [{ label, data }]
    }
  });
}

exportBtn.onclick = () => {
  let csv = "Title,Channel,Date,Views,Likes,Comments\n";
  videos.forEach(v=>{
    csv += `"${v.title}","${v.channel}",${v.published},${v.views},${v.likes},${v.comments}\n`;
  });
  const blob = new Blob(["\uFEFF"+csv], {type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "tn_youtube_dashboard.csv";
  a.click();
};
</script>

</body>
</html>
