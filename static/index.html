<!DOCTYPE html>
let videos=[], chart;
const today = new Date().toISOString().split('T')[0];
end.value = today;
preset(7);


function preset(d){ start.value = new Date(Date.now()-d*86400000).toISOString().split('T')[0]; }


loadBtn.onclick = async () => {
loading.classList.remove('hidden');
const res = await fetch(`/search?query=${query.value}&start=${start.value}&end=${end.value}`);
const data = await res.json();
videos = data.videos;
loading.classList.add('hidden');


tbody.innerHTML = videos.map(v=>`
<tr class="border-t"><td class="p-2">${v.title}</td>
<td class="p-2">${v.channel}</td>
<td class="p-2">${v.published}</td>
<td class="p-2">${v.views}</td>
<td class="p-2">${v.likes}</td>
<td class="p-2">${v.comments}</td></tr>`).join('');


updateSummary();
showKeywords();
drawChart();
};


function updateSummary(){
sumVideos.textContent = videos.length;
sumViews.textContent = videos.reduce((a,b)=>a+b.views,0).toLocaleString();
sumLikes.textContent = videos.reduce((a,b)=>a+b.likes,0).toLocaleString();
sumComments.textContent = videos.reduce((a,b)=>a+b.comments,0).toLocaleString();
}


function showKeywords(){
const freq={};
videos.forEach(v=>v.title.toLowerCase().split(' ').forEach(w=>{
if(w.length>4) freq[w]=(freq[w]||0)+1;
}));
keywords.innerHTML = Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,10)
.map(([w])=>`<span class="px-3 py-1 bg-blue-100 rounded">${w}</span>`).join('');
}


function drawChart(){
chart?.destroy();
chart = new Chart(chartCanvas,{type:'line',data:{labels:videos.map(v=>v.published),datasets:[{label:'Views',data:videos.map(v=>v.views)}]}});
}


exportBtn.onclick = ()=>{
let csv='Title,Channel,Date,Views,Likes,Comments\n';
videos.forEach(v=>csv+=`"${v.title}",${v.channel},${v.published},${v.views},${v.likes},${v.comments}\n`);
const a=document.createElement('a');
a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
a.download='tn_politics_dashboard.csv';a.click();
}
</script>
</body>
</html>
