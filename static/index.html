<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TN Politics YouTube Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-gray-100 p-6">

<h1 class="text-3xl font-bold mb-6">
  Tamil Nadu Politics â€“ YouTube Dashboard
</h1>

<!-- Controls -->
<div class="bg-white p-4 rounded shadow flex flex-wrap gap-3 items-end">

  <input id="query" type="text"
         class="border p-2 rounded w-64"
         value="Tamil Nadu politics" />

  <input id="start" type="date" class="border p-2 rounded" />
  <input id="end" type="date" class="border p-2 rounded" />

  <button onclick="setPreset(7)"
          class="px-3 py-2 bg-gray-200 rounded">7 Days</button>

  <button onclick="setPreset(30)"
          class="px-3 py-2 bg-gray-200 rounded">30 Days</button>

  <button id="loadBtn"
          class="bg-blue-600 text-white px-6 py-2 rounded">
    Load Data
  </button>

  <button id="exportBtn"
          class="bg-green-600 text-white px-6 py-2 rounded">
    Export CSV
  </button>
</div>

<div id="loading"
     class="hidden mt-4 text-blue-600 font-semibold">
  Loading videos...
</div>

<!-- Summary Cards -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">

  <div class="bg-white p-4 rounded shadow text-center">
    <p class="text-gray-500">Videos</p>
    <p id="sumVideos" class="text-2xl font-bold">0</p>
  </div>

  <div class="bg-white p-4 rounded shadow text-center">
    <p class="text-gray-500">Total Views</p>
    <p id="sumViews" class="text-2xl font-bold text-blue-600">0</p>
  </div>

  <div class="bg-white p-4 rounded shadow text-center">
    <p class="text-gray-500">Total Likes</p>
    <p id="sumLikes" class="text-2xl font-bold text-green-600">0</p>
  </div>

  <div class="bg-white p-4 rounded shadow text-center">
    <p class="text-gray-500">Total Comments</p>
    <p id="sumComments" class="text-2xl font-bold text-purple-600">0</p>
  </div>

</div>

<!-- Trending Keywords -->
<div class="bg-white p-4 rounded shadow mt-6">
  <h3 class="font-semibold mb-3">ðŸ”¥ Trending Keywords</h3>
  <div id="keywords" class="flex flex-wrap gap-2"></div>
</div>

<!-- Table -->
<div class="bg-white rounded shadow mt-6 overflow-x-auto">
  <table class="w-full text-sm">
    <thead class="bg-gray-200">
      <tr>
        <th class="p-2">Title</th>
        <th class="p-2">Channel</th>
        <th class="p-2">Date</th>
        <th class="p-2">Views</th>
        <th class="p-2">Likes</th>
        <th class="p-2">Comments</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<!-- Chart -->
<div class="bg-white p-4 rounded shadow mt-6">
  <canvas id="chart" height="120"></canvas>
</div>

<script>
let videos = [];
let chart;

const today = new Date().toISOString().split("T")[0];
document.getElementById("end").value = today;
setPreset(7);

function setPreset(days) {
  document.getElementById("start").value =
    new Date(Date.now() - days * 86400000)
      .toISOString()
      .split("T")[0];
}

document.getElementById("loadBtn").onclick = async () => {
  document.getElementById("loading").classList.remove("hidden");

  const q = document.getElementById("query").value;
  const s = document.getElementById("start").value;
  const e = document.getElementById("end").value;

  const res = await fetch(`/search?query=${encodeURIComponent(q)}&start=${s}&end=${e}`);
  const data = await res.json();

  videos = data.videos || [];
  document.getElementById("loading").classList.add("hidden");

  renderTable();
  updateSummary();
  renderKeywords();
  drawChart();
};

function renderTable() {
  document.getElementById("tbody").innerHTML = videos.map(v => `
    <tr class="border-t">
      <td class="p-2">${v.title}</td>
      <td class="p-2">${v.channel}</td>
      <td class="p-2">${v.published}</td>
      <td class="p-2">${v.views}</td>
      <td class="p-2">${v.likes}</td>
      <td class="p-2">${v.comments}</td>
    </tr>
  `).join("");
}

function updateSummary() {
  let views = 0, likes = 0, comments = 0;
  videos.forEach(v => {
    views += v.views;
    likes += v.likes;
    comments += v.comments;
  });
  sumVideos.textContent = videos.length;
  sumViews.textContent = views.toLocaleString();
  sumLikes.textContent = likes.toLocaleString();
  sumComments.textContent = comments.toLocaleString();
}

function renderKeywords() {
  const freq = {};
  videos.forEach(v => {
    v.title.toLowerCase().split(" ").forEach(w => {
      if (w.length > 4) freq[w] = (freq[w] || 0) + 1;
    });
  });

  document.getElementById("keywords").innerHTML =
    Object.entries(freq)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 12)
      .map(([w]) => `<span class="px-3 py-1 bg-blue-100 rounded">${w}</span>`)
      .join("");
}

function drawChart() {
  chart?.destroy();
  chart = new Chart(document.getElementById("chart"), {
    type: "line",
    data: {
      labels: videos.map(v => v.published),
      datasets: [{
        label: "Views",
        data: videos.map(v => v.views),
        borderWidth: 2
      }]
    }
  });
}

document.getElementById("exportBtn").onclick = () => {
  let csv = "Title,Channel,Date,Views,Likes,Comments\n";
  videos.forEach(v => {
    csv += `"${v.title}","${v.channel}",${v.published},${v.views},${v.likes},${v.comments}\n`;
  });
  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "tn_politics_dashboard.csv";
  a.click();
};
</script>

</body>
</html>
