<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TN Politics Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 p-6">

<h1 class="text-3xl font-bold mb-6">
  Tamil Nadu Politics â€“ YouTube Dashboard
</h1>

<!-- Controls -->
<div class="bg-white p-4 rounded shadow flex flex-wrap gap-3 items-end">
  <input id="query" type="text" class="border p-2 rounded w-64" value="Tamil Nadu politics"/>
  <input id="start" type="date" class="border p-2 rounded"/>
  <input id="end" type="date" class="border p-2 rounded"/>
  <button onclick="setPreset(7)" class="px-3 py-2 bg-gray-200 rounded">7 Days</button>
  <button onclick="setPreset(30)" class="px-3 py-2 bg-gray-200 rounded">30 Days</button>
  <button id="loadBtn" class="bg-blue-600 text-white px-6 py-2 rounded">Load Data</button>
  <button id="exportBtn" class="bg-green-600 text-white px-6 py-2 rounded">Export CSV</button>
</div>

<div id="loading" class="hidden mt-4 text-blue-600 font-semibold">Loading videos...</div>

<!-- Summary Cards -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
  <div class="bg-white p-4 rounded shadow text-center">
    <p class="text-gray-500">Videos</p>
    <p id="sumVideos" class="text-2xl font-bold">0</p>
  </div>
  <div class="bg-white p-4 rounded shadow text-center">
    <p class="text-gray-500">Total Views</p>
    <p id="sumViews" class="text-2xl font-bold text-blue-600">0</p>
  </div>
  <div class="bg-white p-4 rounded shadow text-center">
    <p class="text-gray-500">Total Likes</p>
    <p id="sumLikes" class="text-2xl font-bold text-green-600">0</p>
  </div>
  <div class="bg-white p-4 rounded shadow text-center">
    <p class="text-gray-500">Total Comments</p>
    <p id="sumComments" class="text-2xl font-bold text-purple-600">0</p>
  </div>
</div>

<!-- Trending Keywords -->
<div class="bg-white p-4 rounded shadow mt-6">
  <h3 class="font-semibold mb-3">ðŸ”¥ Trending Keywords</h3>
  <div id="keywords" class="flex flex-wrap gap-2"></div>
</div>

<!-- Table -->
<div class="bg-white rounded shadow mt-6 overflow-x-auto">
  <table class="w-full text-sm">
    <thead class="bg-gray-200">
      <tr>
        <th class="p-2">Title</th>
        <th class="p-2">Channel</th>
        <th class="p-2">Date</th>
        <th class="p-2">Views</th>
        <th class="p-2">Likes</th>
        <th class="p-2">Comments</th>
        <th class="p-2">Link</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<!-- Load More Button -->
<div class="mt-4 text-center">
  <button id="loadMoreBtn" class="bg-yellow-600 text-white px-6 py-2 rounded hidden">
    Load More
  </button>
</div>

<!-- Charts -->
<div class="bg-white p-4 rounded shadow mt-6">
  <h3 class="font-semibold mb-2">Views Trend</h3>
  <canvas id="viewsChart" height="120"></canvas>
</div>
<div class="bg-white p-4 rounded shadow mt-6">
  <h3 class="font-semibold mb-2">Likes Trend</h3>
  <canvas id="likesChart" height="120"></canvas>
</div>
<div class="bg-white p-4 rounded shadow mt-6">
  <h3 class="font-semibold mb-2">Comments Trend</h3>
  <canvas id="commentsChart" height="120"></canvas>
</div>

<script>
let allVideos = [];
let nextPageToken = null;

const loading = document.getElementById("loading");
const tableBody = document.getElementById("tbody");

document.getElementById("loadBtn").onclick = () => {
  allVideos = [];
  nextPageToken = null;
  tableBody.innerHTML = "";
  fetchVideos();
};

document.getElementById("loadMoreBtn").onclick = () => {
  fetchVideos();
};

async function fetchVideos() {
  const query = document.getElementById("query").value.trim();
  const start = document.getElementById("start").value;
  const end = document.getElementById("end").value;

  if (!query || !start || !end) {
    alert("Enter keyword and date range");
    return;
  }

  loading.classList.remove("hidden");

  let url = `/search?query=${encodeURIComponent(query)}&start=${start}&end=${end}`;
  if (nextPageToken) url += `&page_token=${nextPageToken}`;

  try {
    const res = await fetch(url);
    const data = await res.json();

    nextPageToken = data.nextPageToken || null;
    allVideos = allVideos.concat(data.videos || []);

    renderTable(allVideos);
    renderCharts(allVideos);
    updateSummary(allVideos);
    updateKeywords(allVideos);

    // Show/Hide Load More button
    document.getElementById("loadMoreBtn").classList.toggle("hidden", !nextPageToken);

  } catch (e) {
    alert("Error loading videos");
    console.error(e);
  } finally {
    loading.classList.add("hidden");
  }
}

function renderTable(videos) {
  tableBody.innerHTML = videos.map(v => `
    <tr class="border-b">
      <td class="p-2">${v.title}</td>
      <td class="p-2">${v.channel}</td>
      <td class="p-2 text-center">${v.published}</td>
      <td class="p-2 text-right">${v.views}</td>
      <td class="p-2 text-right">${v.likes}</td>
      <td class="p-2 text-right">${v.comments}</td>
      <td class="p-2 text-center">
        <a href="${v.url}" target="_blank" class="text-blue-600 underline">Open</a>
      </td>
    </tr>
  `).join("");
}

/* ===== Charts ===== */
let viewChart, likeChart, commentChart;

function renderCharts(videos) {
  const labels = videos.map(v => v.published);
  const views = videos.map(v => v.views);
  const likes = videos.map(v => v.likes);
  const comments = videos.map(v => v.comments);

  [viewChart, likeChart, commentChart].forEach(c => c && c.destroy());

  viewChart = new Chart(document.getElementById("viewsChart"), {
    type: "line",
    data: { labels, datasets: [{ label: "Views", data: views }] }
  });

  likeChart = new Chart(document.getElementById("likesChart"), {
    type: "line",
    data: { labels, datasets: [{ label: "Likes", data: likes }] }
  });

  commentChart = new Chart(document.getElementById("commentsChart"), {
    type: "bar",
    data: { labels, datasets: [{ label: "Comments", data: comments }] }
  });
}

/* ===== Summary ===== */
function updateSummary(videos) {
  document.getElementById("sumVideos").textContent = videos.length;
  document.getElementById("sumViews").textContent =
    videos.reduce((a,v)=>a+v.views,0);
  document.getElementById("sumLikes").textContent =
    videos.reduce((a,v)=>a+v.likes,0);
  document.getElementById("sumComments").textContent =
    videos.reduce((a,v)=>a+v.comments,0);
}

/* ===== Keywords ===== */
function updateKeywords(videos) {
  const words = {};
  videos.forEach(v => {
    v.title.split(" ").forEach(w => {
      if (w.length > 4) words[w] = (words[w] || 0) + 1;
    });
  });

  document.getElementById("keywords").innerHTML =
    Object.entries(words)
      .sort((a,b)=>b[1]-a[1])
      .slice(0,10)
      .map(([w])=>`<span class="bg-gray-200 px-3 py-1 rounded">${w}</span>`)
      .join("");
}

/* ===== Export CSV ===== */
document.getElementById("exportBtn").onclick = () => {
  if (!allVideos.length) return alert("No data to export");

  let csv = "Title,Channel,Date,Views,Likes,Comments,URL\n";
  allVideos.forEach(v => {
    csv += `"${v.title.replace(/"/g,'""')}","${v.channel}","${v.published}",${v.views},${v.likes},${v.comments},"${v.url}"\n`;
  });

  const blob = new Blob(["\ufeff" + csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "tn_politics_dashboard.csv";
  a.click();
};

/* ===== Date Presets ===== */
function setPreset(days) {
  const end = new Date();
  const start = new Date();
  start.setDate(end.getDate() - days);
  document.getElementById("start").value = start.toISOString().split('T')[0];
  document.getElementById("end").value = end.toISOString().split('T')[0];
}
</script>
</body>
</html>
